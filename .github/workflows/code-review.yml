name: Gemini AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  workflow_run:
    workflows: ["SonarQube Scan (Python)"]   # must match the "name" of sonar.yml
    types:
      - completed

jobs:
  gemini-review:
    name: Gemini AI Code Review
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: stt-environment
    env:
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY || vars.SONAR_PROJECT_KEY || 'myorg_myrepo' }}
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get Pull Request Diff
        id: get_diff
        run: |
          echo "ðŸ” Fetching authenticated PR diff..."
          gh api \
            repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }} \
            --header "Accept: application/vnd.github.v3.diff" \
            > pr_diff.txt
          echo "âœ… Diff saved to pr_diff.txt"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Fetch SonarQube PR analysis
        if: ${{ secrets.SONAR_HOST_URL && secrets.SONAR_TOKEN && env.SONAR_PROJECT_KEY }}
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ env.SONAR_PROJECT_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -e
          echo "ðŸ”Ž Fetching SonarQube data for project=${SONAR_PROJECT_KEY}, PR=${PR_NUMBER}"

          # 1) Issues for this PR (max 500, adjust ps if needed)
          curl -s -u "${SONAR_TOKEN}:" \
            "${SONAR_HOST_URL}/api/issues/search?componentKeys=${SONAR_PROJECT_KEY}&pullRequest=${PR_NUMBER}&ps=500" \
            -o sonar_issues.json || echo "{}" > sonar_issues.json
          echo "Saved sonar_issues.json (size: $(wc -c < sonar_issues.json) bytes)"

          # 2) Quality gate status
          curl -s -u "${SONAR_TOKEN}:" \
            "${SONAR_HOST_URL}/api/qualitygates/project_status?projectKey=${SONAR_PROJECT_KEY}" \
            -o sonar_qg.json || echo "{}" > sonar_qg.json

          # 3) Key measures (bugs, vulnerabilities, code smells, coverage, duplicated_lines_density)
          curl -s -u "${SONAR_TOKEN}:" \
            "${SONAR_HOST_URL}/api/measures/component?component=${SONAR_PROJECT_KEY}&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density" \
            -o sonar_measures.json || echo "{}" > sonar_measures.json

          # 4) Summarize issues (top 20) into human readable text
          echo "### SonarQube Analysis Summary for PR #${PR_NUMBER}" > sonar_summary.txt
          echo "" >> sonar_summary.txt

          # Quality gate short summary
          echo "Quality Gate:" >> sonar_summary.txt
          jq -r '.projectStatus | "  status: " + (.status // "UNKNOWN") + (if .conditions then "\\n  conditions:\\n" + (.conditions[] | ("    - " + .metric + ": " + .status + " (" + (.actual.value|tostring) + ")")) else "" end)' sonar_qg.json >> sonar_summary.txt || echo "  Unable to fetch quality gate" >> sonar_summary.txt
          echo "" >> sonar_summary.txt

          # Key measures
          echo "Key metrics:" >> sonar_summary.txt
          jq -r '.component.measures[] | "  - " + .metric + ": " + (.value // "null")' sonar_measures.json >> sonar_summary.txt || echo "  Unable to fetch measures" >> sonar_summary.txt
          echo "" >> sonar_summary.txt

          # Top issues formatting: severity, rule, component(path), line, message
          echo "Top Sonar issues (up to 20):" >> sonar_summary.txt
          jq -r '.issues | sort_by(.severity) | reverse | .[] | ("  - [" + (.severity // "INFO") + "] " + (.rule // "unknown") + " / " + (.component // "unknown") + (if .line then ":" + (.line|tostring) else "" end) + " â€” " + (.message|gsub("\n"; " ")))' sonar_issues.json | sed -n '1,20p' >> sonar_summary.txt || echo "  No issues found or failed to parse" >> sonar_summary.txt
          echo "" >> sonar_summary.txt

          # Count of issues by severity
          echo "Issue counts by severity:" >> sonar_summary.txt
          jq -r '.issues | group_by(.severity) | map({(.[0].severity): length}) | add | to_entries[] | "  - " + .key + ": " + (.value|tostring)' sonar_issues.json >> sonar_summary.txt 2>/dev/null || echo "  none" >> sonar_summary.txt
          echo "" >> sonar_summary.txt

          # Save full JSON artifacts (optional) for debugging
          ls -l sonar_*.json sonar_summary.txt
          echo "âœ… Sonar summary prepared at sonar_summary.txt"

      - name: Combine Prompt, Sonar summary and Diff
        run: |
          echo "ðŸ§© Combining Gemini base prompt with PR diff and Sonar summary..."
          cat .gemini/prompt.txt > full_prompt.txt
          echo -e "\n\n## ðŸ”Ž SonarQube Summary\n\n" >> full_prompt.txt
          if [ -f sonar_summary.txt ]; then
            cat sonar_summary.txt >> full_prompt.txt
          else
            echo "No Sonar summary available." >> full_prompt.txt
          fi
          echo -e "\n\n## ðŸ”„ Full Diff Below\n\n" >> full_prompt.txt
          cat pr_diff.txt >> full_prompt.txt
          echo "âœ… Full prompt ready at full_prompt.txt"

      - name: Load Prompt from File
        id: load_prompt
        run: |
          PROMPT_CONTENT=$(cat full_prompt.txt)
          echo "prompt_text<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Gemini Code Review
        uses: google-github-actions/run-gemini-cli@v0.1.14
        with:
          gemini_model: "gemini-2.5-pro"
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          use_vertex_ai: false
          use_gemini_code_assist: false
          prompt: ${{ steps.load_prompt.outputs.prompt_text }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Save Gemini Output
        run: |
          echo "ðŸ“„ Saving Gemini output..."
          cat gemini-artifacts/stdout.log > gemini_output.txt || echo "No Gemini output found!"

      - name: Post Gemini Review as PR Comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('gemini_output.txt', 'utf8');
            const comment = output.trim() ? output : "No Gemini review output generated.";
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `### ðŸ¤– Gemini Code Review Result\n\n${comment}`
            });